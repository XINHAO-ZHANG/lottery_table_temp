<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>TurnTable</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div class="wrapper">
    <div class="panel">
      <div class="pointer">开始抽奖</div>
    </div>
  </div>
  <div class="result"></div>
  <script>
    let pointer = document.getElementsByClassName('pointer')[0];
    let result = document.getElementsByClassName('result')[0];
    let onRotation = false; // 记录当前是否正在旋转

    let reward = ['山楂', '棒棒糖', '脆香米', '小熊饼干', '铅笔', '本子', '橡皮擦'];

    function render() {
      let wrapper = document.getElementsByClassName('wrapper')[0];
      let panel = document.getElementsByClassName('panel')[0];
      let totalDegrees = 360;
      let degreesPerReward = totalDegrees / reward.length;

      for (let i = 0; i < reward.length; i++) {
        let sector = document.createElement('div');
        sector.className = 'sector';
        sector.style.transform = `rotate(${i * degreesPerReward}deg) skewY(${90 - degreesPerReward / 2}deg)`;

        let sector_inner = document.createElement('div');
        sector_inner.className = 'sector-inner';
        sector_inner.style.transform = `skewY(${-(90 - degreesPerReward / 2)}deg)`;

        let span = document.createElement('span');
        span.appendChild(document.createTextNode(reward[i]));

        sector_inner.appendChild(span);
        sector.appendChild(sector_inner);
        panel.appendChild(sector);
      }
    }
    render();

    let preDeg = [];  // 记录之前的度数
    let i = 0;
    let getReward = function () {
      let currentDeg = 0;  // 当前角度数
      return function () {
        let rotateDeg = Math.random() * 360 + 1800; // 转5圈到6圈
        currentDeg += rotateDeg;
        preDeg[i++] = currentDeg % 360;
        console.log('currentDeg', currentDeg);
        let rewardIndex = Math.floor((currentDeg % 360) / (360 / reward.length));
        let rewardText = reward[rewardIndex];
        return {
          deg: currentDeg,
          text: '恭喜获得: ' + rewardText
        };
      };
    };

    pointer.addEventListener('click', function () {
      if (!onRotation) {
        console.log('开始抽奖');
        onRotation = true;
        let nextStatus = getReward()();
        console.log(nextStatus);
        result.innerHTML = nextStatus.text;
        result.style.display = 'none';
        pointer.animate([
          { transform: `rotateZ(${preDeg[i-1] || 0}deg)` },
          { transform: `rotateZ(${nextStatus.deg}deg)` }
        ], {
          duration: 3000,
          easing: "cubic-bezier(.2,.93,.43,1)"
        });
        pointer.style.transform = `rotateZ(${nextStatus.deg}deg)`;
        setTimeout(() => {
          result.style.display = 'block';
          onRotation = false;
          console.log('抽奖结束');
        }, 3000);
      }
    });
  </script>
  <noscript>
    <p>本页面需要在浏览器支持启用JavaScript</p>
  </noscript>
</body>
</html>
